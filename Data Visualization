install.packages("ggplot2")
library("ggplot2", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
install.packages(c("dbplyr", "RSQLite"))
#double check that you have these three boxed off on the right under packages 
library(dplyr)
library(dbplyr)
library(RSQLite)

#connecting sql to R 
# the "~/Documents" is subject to change on each persons computer
con <- dbConnect(drv=RSQLite::SQLite(), "~/Desktop/ipds_project/fareboxdb.sqlite")

#checking db contents
#dbListTables(con)
#dbListFields(con, "farebox_data")

## list all tables
#tables <- dbListTables(con)

##list all columns
#columns <- dbListFields(con, "farebox_data")

## exclude sqlite_sequence (contains table information)
tables <- tables[tables != "sqlite_sequence"]

df <- vector("list", length = length(tables))

## create a data.frame for each table
for (i in seq(along=tables)) {
  df[[i]] <- dbGetQuery(conn=con, statement=paste("SELECT * FROM '", tables[[i]], "'", sep=""))
}


#making sure its a dataframe
#class(dbGetQuery(conn=con, statement=paste("SELECT * FROM '", tables[[1]], "'", sep="")))

#summary(df)

#creating dataframe
fbdata <- df[[1]]
flatdb <- df[[2]]
nonzerodb <- df[[3]]

summary(fbdata)


#The unconditioned distribution of fare collection rates 

ggplot(data = fbdata, aes(x=ratio)) + geom_density() +
  ggtitle("Distribution of fare collection rates")+
  labs(y="Density", x="Ratio")

#Scatter plot showing fare collection rates versus rates for flat rate systems 

ggplot(data = flatdb, aes(y=ratio, x= fare_rate, color = ratio)) + 
  geom_point(alpha = 1) +
  ggtitle("Fare Collection Ratio vs Flat System Rate Fares")+
  labs(y="Ratio", x = "Flat System Fare Rates") + scale_fill_discrete(guide=FALSE)

#Create a "joy plot" of the distribution of farebox ratios by fare system

ggplot(nonzerodb, aes(x =ratio, y = fare_system , fill = fare_system))+ 
  geom_joy(scale=1.5, rel_min_height=.01, alpha = 0.7) + 
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "Farebox ratio", y= "Fare System" , title = "Fare ratio by fare system")
  theme_joy() + scale_fill_discrete(guide=FALSE)

#Create a "joy plot" of the distribution of farebox ratios by continent 
 
ggplot(fbdata, aes(x =ratio, y = continent, fill = continent))+ 
  geom_joy(scale=1.5, rel_min_height=.01, alpha = 0.7) + 
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(x = "Farebox Ratio", y= "Continent" , title = "Fare Collection Rates by Continent")
theme_joy() + scale_fill_discrete(guide=FALSE)
